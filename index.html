<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Deeplinkr</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
  <style>
  </style>
</head>
<body>
  <div class="container">
    <h1>Deeplinkr</h1>
    <form>
      <div class="mb-3">
        <label for="app" class="form-label">Wähle eine App:</label>
        <select class="form-select" id="app">
        </select>
      </div>
      <div class="mb-3">
        <label for="stage" class="form-label">Wähle eine Stage:</label>
        <select class="form-select" id="stage">
        </select>
      </div>
    </form>

    <table id="deeplink-table" class="table">
      <tbody>
      </tbody>
    </table>
  </div>
  <script src="/static/js/qrcode.min.js"></script>
  <script>

const functionsByApp = {
   'default': ['', 'dashboard', 'settings', 'pfm', 'service', 'products', 'wero', 'webview'],
   'spkapp': ['', 'dashboard', 'settings', 'pfm', 'service', 'products', 'wero', 'webview'],
   'bwbank': ['', 'dashboard', 'settings', 'pfm', 'service', 'products', 'wero'],
   'sbs': ['', 'dashboard', 'settings', 'service', 'products', 'lexware'],
   'sinvest': ['', 'portfolio', 'news', 'markets', 'settings'],
   'spushtan': ['', 'confirmation', 'connections', 'history', 'settings'],
   'showcase': ['', 'showAlert', 'iam', 'settings', 'log', 'webview']
};

const stageIdsToNames = {
  "www": "S-Com Prod",
  "stage-www": "S-Com Staging",
  "app": "SF App",
  "special": "FSi"
}

const stageIdsToHosts = {
  "www": "https://www.sparkasse.de",
  "stage-www": "https://stage-www.sparkasse.de",
  "app": "https://app.sparkasse.de",
  "special": "https://www.fsiebecke.de"
}

const appIdsToNames = {
  "default": "Standard",
  "spkapp": "Sparkasse",
  "bwbank": "BW-Bank-App",
  "sbs": "Sparkasse Business",
  "sinvest": "S-Invest",
  "spushtan": "S-PushTAN-App",
  "showcase": "Showcase App"
}

const manufacturerByStage = {
'www': 'sf',
'stage-www': 'sf',
'app': 'sf',
'special': 'fsi'
}
const appsByManufacturers = {
 'sf': ['default', 'spkapp', 'sbs', 'sinvest', 'spushtan'],
 'fsi': ['showcase']
}

const manufacturersByApps = {
 'default': 'sf',
 'spkapp': 'sf',
 'sbs': 'sf',
 'sinvest': 'sf',
 'spushtan': 'sf',
 'bwbank': 'sf',
 'showcase': 'fsi'
}

const stagesByManufacturers = {
 'sf': ['www','stage-www','app'],
 'fsi': ['special']       
}
 
let currentQrCode; // Globale Variable, um auf den QR-Code zuzugreifen

function getApps() {
  return Object.keys(functionsByApp);
};

function getSupportedDeeplinkFunctions(app) {
  return functionsByApp[app] || [];
};

function getSupportedStages(app) {
  const manufacturer = manufacturersByApps[app];
  if ( manufacturer ) {
    return stagesByManufacturers[manufacturer];
  }
  return null;
};

function getAppName ( appId ) {
  return appIdsToNames[appId] || "";
};

function getStageName ( stageId ) {
  return stageIdsToNames[stageId] || "";
};

function getStageHost ( stageId ) {
  return stageIdsToHosts[stageId] || "";
};

function collapseAllDetails() {
  const selectedApp = document.getElementById('app').value;
  const allFunctions = getSupportedDeeplinkFunctions(selectedApp);
  allFunctions.forEach(functionName => {
    const detailsRow = document.querySelector(`#${functionName}-details-row`);
    if ( detailsRow ) {
      detailsRow.style.display = 'none';
    }
    const qrRow = document.querySelector(`#${functionName}-qr-row`);
    if ( qrRow ) {
      qrRow.style.display = 'none';
    }
    const webViewParamsRow = document.querySelector(`#${functionName}-webview-params-row`);
    if ( webViewParamsRow ) {
      webViewParamsRow.style.display = 'none';
    }
  });
};

function populateStageSelector(appId) {
  const manufacturer = manufacturersByApps[appId] || '';
  const stages = getSupportedStages(appId);
  const previousStageId = document.getElementById('stage').value;

  // Füllen der App-Auswahl mit den benutzerfreundlichen Namen, abhängig von der Stage
  const stageSelect = document.getElementById('stage');
  stageSelect.innerHTML = ''; // Zuerst alle Optionen entfernen

  for (const stageIdIndex in stages) {
    const currentStageId = stages[stageIdIndex];
    const stageName = getStageName(currentStageId);

    const option = document.createElement('option');
    option.value = currentStageId;
    option.text = stageName;

    stageSelect.appendChild(option);
  }
  
  if (!stages.includes(previousStageId)) {
    document.getElementById('stage').value = stages[0];
  }
};

function generateUrl(functionName, appId, stageId) {
  const appName = getAppName ( appId );
  const host = getStageHost ( stageId );

  const tableBody = document.getElementById('deeplink-table').querySelector('tbody');
  
  let fullUrl = appId && appId != "default" && appId != 'showcase' ? `${host}/_deeplink/${appId}/${functionName}` : `${host}/_deeplink/${functionName}`;

  if ( functionName === "webview" ) {
    // Hole die Werte aus den Formularfeldern
    const path = document.getElementById("path")?.value;
    const blz = document.getElementById("blz")?.value;
    const urlParams = document.getElementById("urlParams")?.value;
    const ifSilentLogin = document.getElementById("ifSilentLogin")?.value;
    const fallback = document.getElementById("fallback")?.value;
    if ( path ) {
      fullUrl = fullUrl + "?path=" + encodeURIComponent(path)
    }
    if ( blz && blz != "" ) {
      fullUrl = fullUrl + "&blz=" + blz
    }
    if ( ifSilentLogin && ifSilentLogin != "" ) {
      fullUrl = fullUrl + "&IF_SILENT_LOGIN=" + (ifSilentLogin ? "true" : "false")
    }
    if ( fallback && fallback != "" ) {
      fullUrl = fullUrl + "&fallback=" + fallback.toLowerCase();
    }
    if ( urlParams && urlParams != "" ) {
      fullUrl = fullUrl + "&" + urlParams
    }
  }
  return fullUrl
}


function buildDeeplinkFunctionTable(app, stage) {
  const allFunctions = getSupportedDeeplinkFunctions(app);
  const tableBody = document.getElementById('deeplink-table').querySelector('tbody');
  tableBody.innerHTML = '';
  allFunctions.forEach(functionName => {
    console.log("adding function " + functionName );
    const headerRow = document.createElement('tr');
    headerRow.id = `${functionName}-header-row`;
    const titleCell = document.createElement('td');
    titleCell.textContent = functionName || 'appstart';
    titleCell.style.fontWeight = 'bold';
    let detailsRowVisible = false;
    titleCell.onclick = () => {
      collapseAllDetails();
      detailsRowVisible = !detailsRowVisible;
      console.log("titleCell.onclick... visible: " + (detailsRowVisible ? "true" : "false") );
      if ( detailsRowVisible ) {
        const fullUrl = generateUrl(functionName, app, stage);
        
        const webViewParamsRow = document.querySelector(`#${functionName}-webview-params-row`);
        if ( webViewParamsRow  && functionName == "webview" ) {
          webViewParamsRow.style.display = 'table-row';
        }
        if ( !webViewParamsRow && functionName == "webview" ) {
          const webviewParamsRow = document.createElement('tr');
          webviewParamsRow.id = `${functionName}-webview-params-row`;
          const webviewParamsCell = document.createElement('td');
          webviewParamsCell.innerHTML = `
            <br/>
            <table class="table">
              <tbody>
                <tr>
                  <td><label for="path">Pfad:</label></td>
                </tr>
                <tr>
                  <td><input type="text" id="path" name="path" value="de/home/privatkunden/versicherungen/mopedversicherung-sv.webview.html"></td>
                </tr>
                <tr>
                  <td><label for="blz">BLZ:</label></td>
                </tr>
                <tr>
                  <td><input type="text" id="blz" name="blz" value="94059421"></td>
                </tr>
                <tr>
                  <td><label for="urlParams">URL-Parameter:</label></td>
                </tr>
                <tr>
                  <td><input type="text" id="urlParams" name="urlParams" value="wstart=true&n=true"></td>
                </tr>
                <tr>
                  <td><label for="ifSilentLogin">IF_SILENT_LOGIN:</label></td>
                </tr>
                <tr>
                  <td><input type="checkbox" id="ifSilentLogin" name="ifSilentLogin" checked/></td>
                </tr>
                <tr>
                  <td><label for="fallback">Fallback:</label></td>
                </tr>
                <tr>
                  <td>
                    <select id="fallback" name="fallback">
                      <option value="IF">IF</option>
                      <option value="Store">Store</option>
                      <option value="Choice">Choice</option>
                    </select>
                  </td>
                </tr>
              </tbody>
            </table>`;

          webviewParamsRow.appendChild(webviewParamsCell);
          headerRow.parentNode.insertBefore(webviewParamsRow, headerRow.nextSibling);

          // Add event listeners to each input element
          const pathInput = document.getElementById("path");
          const blzInput = document.getElementById("blz");
          const urlParamsInput = document.getElementById("urlParams");
          const ifSilentLoginInput = document.getElementById("ifSilentLogin");
          const fallbackSelect = document.getElementById("fallback");

          pathInput.addEventListener("change", updateWebViewLinkAndQr);
          blzInput.addEventListener("change", updateWebViewLinkAndQr);
          urlParamsInput.addEventListener("change", updateWebViewLinkAndQr);
          ifSilentLoginInput.addEventListener("change", updateWebViewLinkAndQr);
          fallbackSelect.addEventListener("change", updateWebViewLinkAndQr);
        }

        const qrRow = document.querySelector(`#${functionName}-qr-row`);
        if ( qrRow ) {
          qrRow.style.display = 'table-row';
        } else {
          const qrRow = document.createElement('tr');
          qrRow.id = `${functionName}-qr-row`;

          const qrCell = document.createElement('td');
          qrCell.id = `${functionName}-qr-cell`;

          if ( functionName == "webview" ) {
            currentQrCode = new QRCode(qrCell, {
                text: fullUrl,
                width: 200,
                height: 200
              });
          } else {
            const currentQrCode = new QRCode(qrCell, {
                text: fullUrl,
                width: 200,
                height: 200
              });
          }

          qrRow.appendChild(qrCell);
          
          headerRow.parentNode.insertBefore(qrRow, headerRow.nextSibling);

        };
        
        const detailsRow = document.querySelector(`#${functionName}-details-row`);
        if ( detailsRow ) {
          detailsRow.style.display = 'table-row';
        } else {
          const detailsRow = document.createElement('tr');
          detailsRow.id = `${functionName}-details-row`;
          const detailsCell = document.createElement('td'); 
          detailsCell.id = `${functionName}-details-cell`;
          const link = document.createElement('a');

          // Set the link text and URL
          link.textContent = generateUrl(functionName, app, stage);
          link.href = generateUrl(functionName, app, stage);

          // Append the link to the cell
          detailsCell.appendChild(link);

          // Append the cell with link and QR code to the details row
          detailsRow.appendChild(detailsCell);

          headerRow.parentNode.insertBefore(detailsRow, headerRow.nextSibling);
        };
        if ( functionName == "webview" ) {
          updateWebViewLinkAndQr();
        } else {
          currentQrCode.clear(); // Alten QR-Code löschen
          currentQrCode.makeCode(fullUrl); // Neuen QR-Code erzeugen
        };
      }
    };
    headerRow.appendChild(titleCell);
    tableBody.appendChild(headerRow);
  });
}

function updateWebViewLinkAndQr() {
  const selectedApp = document.getElementById('app').value;
  const selectedStage = document.getElementById('stage').value;
  const fullUrl = generateUrl('webview', selectedApp, selectedStage);

  const detailsCell = document.getElementById('webview-details-cell');
  const link = detailsCell.querySelector("a");
  link.textContent = fullUrl;
  console.log("updated full url: "+fullUrl);
  link.href = fullUrl;
  currentQrCode.clear(); // Alten QR-Code löschen
  currentQrCode.makeCode(fullUrl); // Neuen QR-Code erzeugen
}

// Beim Laden der Seite:
const savedApp = localStorage.getItem('selectedApp');
const savedStage = localStorage.getItem('selectedStage');

// Füge Event Listener für die Auswahlfelder hinzu
document.getElementById('app').addEventListener('change', () => {
  // die Auswahl in der Liste "app" wurde verändert
  const selectedApp = document.getElementById('app').value; // hole die ausgewählte App
  localStorage.setItem('selectedApp', selectedApp); // Speichere die ausgewählte app
  populateStageSelector(selectedApp); // befülle die Auswahlliste "stage" mit den Werten, die für die gewählte App gültig sind. Setze möglichst die vorausgegangene Auswahl
  const currentStage = document.getElementById('stage').value; // ermittle die derzeitige Auswahl der Stage. Entweder ist es die vorausgegangene Stage oder, wenn diese nicht von der aktuellen App unterstützt wird, die default-Stage der App
  buildDeeplinkFunctionTable(selectedApp, currentStage); // baue die Deeplink-Tabelle neu auf
});

document.getElementById('stage').addEventListener('change', () => {
  // die Auswahl in der Liste "stage" wurde verändert
  const selectedStage = document.getElementById('stage').value; // ermittle die gewählte Stage
  localStorage.setItem('selectedStage', selectedStage); // Speichere die ausgewählte Stage
  const selectedApp = document.getElementById('app').value; // wir brauchen auch die aktuell gewählte App, um die Tabelle neu zu bauen
  buildDeeplinkFunctionTable(selectedApp, selectedStage); // tabelle bauen
});

// Füllen des Auswahlfelds App mit den benutzerfreundlichen Namen
const appSelect = document.getElementById('app'); // das Select-Element für die Auswahl der App
const apps = getApps(); // alle Apps
for (const appId of getApps()) {
  const option = document.createElement('option');
  option.value = appId;
  option.text = appIdsToNames[appId];
  appSelect.appendChild(option);
}   

document.getElementById('app').value = savedApp || ""; // falls zuvor einmal eine App gesetzt wurde, hier diese Auswahl wiederherstellen
const selectedApp = document.getElementById('app').value; // welche App ist es nun geworden?
// Füllen des Auswahlfelds Stage mit den benutzerfreundlichen Namen
populateStageSelector(selectedApp);
document.getElementById('stage').value = savedStage || ""; // falls zuvor einmal eine Stage gesetzt wurde, hier diese Auswahl wiederherstellen
const selectedStage = document.getElementById('stage').value; // welche Stage ist es nun geworden?

buildDeeplinkFunctionTable(selectedApp, selectedStage); // Tabelle mit den gewählten Deeplink-Funktionen füllen

  </script>
 </body>
</html>
